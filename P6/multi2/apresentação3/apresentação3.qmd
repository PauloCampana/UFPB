---
format:
    revealjs:
        theme: moon
lang: pt
title: An√°lise de correla√ß√£o can√¥nica e An√°lise de descriminante
subtitle: An√°lise Multivariada II
author: Paulo Ricardo Seganfredo Campana
date: today
date-format: long
callout-icon: false
highlight-style: github
monofontoptions: Scale = 1
logo: includes/logo.png
echo: true
self-contained-math: true
self-contained: true
embed-resources: true
# cache: true
---

## Resumo dos dados
Os dados s√£o sobre o consumo de energia el√©trica, g√°s natural e emiss√µes de gases do efeito estufa em pr√©dios e constru√ß√µes grandes na cidade de Chicago.

Temos dois principais tipos de vari√°veis neste banco:

* Vari√°veis de medida bruta (consumo de energia el√©trica, g√°s natural, emiss√£o de gases).
* Vari√°veis normalizadas pela √°rea da constru√ß√£o (consumo por metro quadrado, emiss√µes por metro quadrado).

## Resumo dos dados
S√£o 8937 observa√ß√µes cada uma correspondente a uma constru√ß√£o com informa√ß√µes de 12 vari√°veis entre elas 9 num√©ricas cont√≠nuas e ser√£o divididas em duas matrizes de dados para an√°lise de correla√ß√£o can√¥nica.

```{r}
#| warning: false
library(tidyverse)

data <- read_csv("energy.csv")

X <- data |>
    select(area, ghg_total, electricity, natural_gas) |>
    mutate(across(everything(), scale)) |>
    as.matrix()

Y <- data |>
    select(ghg_intensity, eui_site, eui_source, eui_site_wn, eui_source_wn) |>
    mutate(across(everything(), scale)) |>
    as.matrix()
```

```{r}
#| echo: false
options(digits = 3)
set.seed(0)

theme_moon <- theme(
    plot.background = element_rect("#002b36"),
    panel.background = element_blank(),
    panel.grid = element_line("#93a1a120"),
    panel.grid.minor = element_blank(),
    axis.ticks = element_line("#93a1a120"),
    strip.background = element_rect("#104b56"),
    text = element_text(colour = "#93a1a1"),
    axis.text = element_text(colour = "#93a1a1"),
    strip.text = element_text(colour = "#93a1a1"),
    legend.background = element_blank(),
    legend.key = element_blank(),
)
```

## Correla√ß√£o
Vemos pela matriz de correla√ß√£o a seguir que existe dois grupos distintos de vari√°veis com alta correla√ß√£o dentro dos grupos e baixa correla√ß√£o entre os grupos: as vari√°veis de medida bruta e aquelas normalizadas pela √°rea.

```{r}
#| output: false
data |>
    relocate(ghg_intensity, .before = eui_site) |>
    select(-property_type, -stars, -score) |>
    cor() |>
    corrplot::corrplot(
        method = "ellipse",
        col = viridis::cividis(200),
        tl.col = "#93a1a1",
        tl.pos = "l",
        cl.ratio = 0.25,
    )
```

## Correla√ß√£o
![](includes/corrplot.png){fig-align=center}

## An√°lise de correla√ß√£o can√¥nica
Com esses 2 grupos de vari√°veis, fica claro como definir uma an√°lise de correla√ß√£o can√¥nica, o objetivo √© criar para cada grupo uma ou duas novas vari√°veis como combina√ß√£o linear das originais de modo que expliquem a maior parte da varia√ß√£o total dos grupos.

```{r}
#| output: false
cca <- yacca::cca(X, Y)
summary(cca)
```

Assim temos as novas vari√°veis $U_1, \cdots, U_4$ e $V_1, \cdots, V_4$, que tentam representar as vari√°veis da matriz $X$ e $Y$ de forma que cada par $U_k$ e $V_k$ tenha vari√¢ncia 1, correla√ß√£o m√°xima e n√£o correlacionadas com o par anterior.

## Correla√ß√£o entre os Pares
As correla√ß√µes entre os pares de vari√°veis can√¥nicas n√£o foram t√£o grandes pois como vimos n√£o h√° grande correla√ß√£o entre os dois grupos de vari√°veis.

A correla√ß√£o ao quadrado pode ser interpretada como a fra√ß√£o da vari√¢ncia entre os grupos proporcionada por cada par can√¥nico.

: Correla√ß√£o entre os pares de vari√°veis can√¥nicas

|Pares                   |VC$_1$|VC$_2$|VC$_3$|VC$_4$|
|:-----------------------|-----:|-----:|-----:|-----:|
|$\text{Cor}(U_k, V_k)$  | 0.597| 0.531| 0.204| 0.077|
|$\text{Cor}(U_k, V_k)^2$| 0.357| 0.282| 0.042| 0.006|

## Teste de Bartlett
Este teste tem a hip√≥tese nula de que a matriz de covari√¢ncia cruzada entre os dois grupos √© 0, caso isso aconte√ßa, n√£o faz muito sentido o uso da an√°lise de correla√ß√£o can√¥nica.

: Teste Chi-quadrado de Bartlett

|Pares |Correla√ß√£o$^2$|Estat√≠stica| gl|$p$-valor|
|:-----|-------------:|----------:|--:|--------:|
|VC$_1$|         0.357|       7325| 20|$< 0.001$|
|VC$_2$|         0.282|       3387| 12|$< 0.001$|
|VC$_3$|         0.042|        433|  6|$< 0.001$|
|VC$_4$|         0.006|       52.6|  2|$< 0.001$|

## Coeficientes das vari√°veis can√¥nicas {.smaller}
: Coeficientes lineares para $U$

|Vari√°vel    | U$_1$| U$_2$| U$_3$| U$_4$|
|:-----------|-----:|-----:|-----:|-----:|
|√Årea        | 0.222|-1.601|-0.175|-1.179|
|Emiss√µes    | 3.526|-2.181| 5.332|-0.871|
|Eletricidade|-4.076| 3.276|-3.952| 1.098|
|G√°s natural | 0.114| 1.230|-1.494| 0.007|

: Coeficientes lineares para $V$

|Vari√°vel       |  V$_1$|  V$_2$|  V$_3$|  V$_4$|
|--------------:|------:|------:|------:|------:|
|Emiss√µes/$m^2$ |  2.066| -0.586|  8.950|  1.065|
|Total$_1$/$m^2$| -6.965| -2.167| -8.917|-39.497|
|Total$_2$/$m^2$|  9.202|  7.429|  3.318| 33.648|
|Total$_3$/$m^2$|  9.181|  2.478|  8.663| 39.092|
|Total$_4$/$m^2$|-13.298| -6.128|-11.867|-34.043|

## Das vari√°veis can√¥nicas e originais
: Correla√ß√£o ao quadrado entre $X$ e $U$

|Vari√°vel    |U$_1$|U$_2$|U$_3$|U$_4$| |Soma|
|:-----------|----:|----:|----:|----:|-|---:|
|√Årea        |0.057|0.003|0.001|0.940| |   1|
|Emiss√µes    |0.034|0.241|0.149|0.576| |   1|
|Eletricidade|0.164|0.197|0.109|0.530| |   1|
|G√°s natural |0.196|0.328|0.028|0.448| |   1|
|            |     |     |     |     | |    |
|M√©dia       |0.113|0.192|0.072|0.623| |   1|

## Das vari√°veis can√¥nicas e originais
: Correla√ß√£o ao quadrado entre $Y$ e $V$

|Vari√°vel       |V$_1$|V$_2$|V$_3$|V$_4$| | Soma|
|--------------:|----:|----:|----:|----:|-|----:|
|Emiss√µes/$m^2$ |0.012|0.941|0.030|0.001| |0.984|
|Total$_1$/$m^2$|0.103|0.868|0.002|0.000| |0.973|
|Total$_2$/$m^2$|0.015|0.967|0.004|0.001| |0.987|
|Total$_3$/$m^2$|0.109|0.848|0.003|0.003| |0.963|
|Total$_4$/$m^2$|0.013|0.959|0.003|0.004| |0.979|
|               |     |     |     |     | |     |
|M√©dia          |0.005|0.917|0.009|0.002| |0.977|

## Das vari√°veis can√¥nicas entre os grupos
: Fra√ß√£o de vari√¢ncia cruzada total explicada pelas vari√°veis can√¥nicas

|            |VC$_1$|VC$_2$|VC$_3$|VC$_4$| | Soma|
|:----------:|-----:|-----:|-----:|-----:|-|----:|
|$X$ dado $Y$| 0.040| 0.054| 0.003| 0.003| |0.101|
|$Y$ dado $X$| 0.018| 0.258| 0.001| 0.000| |0.276|

## Gr√°ficos
Estes trazem as mesmas informa√ß√µes vistas nas tabelas anteriores: as correla√ß√µes e correla√ß√µes ao quadrado entre os pares can√¥nicos, entre os grupos de vari√°veis e entre as vari√°veis e os pares.

```{r}
#| output-location: slide
#| out-width: 100%
#| fig-height: 8
par(
    bg = "#002b36", fg = "#93a1a1",
    col = "#93a1a1", col.axis = "#93a1a1",
    col.main = "#93a1a1", col.lab = "#93a1a1",
    pch = 19
)
yacca::plot.cca(cca)
```

## An√°lise de correla√ß√£o can√¥nica
Em suma, n√£o h√° muita correla√ß√£o entre os dois grupos de vari√°veis assim a correla√ß√£o entre os pares can√¥nicos rapidamente decaem.

Os pares podem ser calculados como combina√ß√£o linear das vari√°veis originais utilizando os coeficientes dados na tabela.

A maior parte da vari√¢ncia de cada grupo √© explicado por uma vari√°vel can√¥nica: $U_4$ e $V_2$ para $X$ e $Y$ respectivamente.

## An√°lise de discriminante
Utilizando a mesma estrutura dos dados da apresenta√ß√£o anterior, focando em 3 tipos de propriedade: hoteis, escolas e supermercados sendo eles 274, 1483, 168 observa√ß√µes respectivamente totalizando 1925.

* üü® Amarelo: hoteis
* üü© Verde: escolas
* üü• Vermelho: supermercados

```{r}
data <- read_csv("energy.csv") |>
    relocate(ghg_intensity, .before = eui_site) |>
    filter(property_type %in% c(
        "Hotel", "K-12 School", "Supermarket/Grocery Store"
    )) |>
    mutate(property_type = factor(property_type,
        labels = c("Hotel", "Escola", "Supermercado"),
    ))
```

## Caso linear
Esta an√°lise busca estabelecer por regras simples, maneiras de diferenciar observa√ß√µes em grupos, desta vez trabalhando na forma de modelo estat√≠stico e utilizando a informa√ß√£o real dos grupos.

As regras de decis√£o para este caso ser√£o feitas atrav√©s de desigualdades lineares entre duas vari√°veis.

```{r}
library(MASS)
set.seed(0)

idx <- sample(nrow(data), 500)
train <- data[-idx, ]
test <- data[idx, ]

lda <- lda(property_type ~ . - stars - score, train)
```

## Acur√°cia {.smaller}
Vemos que os supermercados ficaram bem classificados pois eles tem maior consumo de energia por metro quadrado, as escolas tamb√©m foram classificadas na grande maioria corretamente por√©m foi dif√≠cil distiguir os hoteis, sendo metade deles mal classificados.

Por outro lado, as medidas de acur√°cia da classifica√ß√£o foram boas.

```{r}
#| output: false
predict <- predict(lda, test)$class
cm <- caret::confusionMatrix(test$property_type, predict)
cm$table
cm$byClass[,1:2]
```

|Classe      |Hotel|Escola|Supermercado|Sensitividade|Especificidade|
|:-----------|----:|-----:|-----------:|------------:|-------------:|
|Hotel       |   34|    38|           1|        0.756|         0.914|
|Escola      |    7|   382|           0|        0.910|         0.912|
|Supermercado|    4|     0|          34|        0.971|         0.991|

## Acur√°cia

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 8
#| fig-height: 6
ggord::ggord(
    lda, train$property_type,
    cols = c("#ffcc32", "#7cb342", "#f44336"),
    hull = TRUE, ellipse = FALSE, alpha_el = 0.25,
    arrow = NULL, txt = NULL,
    size = 1.5,
    xlims = c(-5.5, 15.5), ylims = c(-5.5, 15.5),
    coord_fix = FALSE
) + scale_shape_manual(values = c(24, 21, 22)) +
    theme_moon
```

## Parti√ß√£o dos grupos
O conjunto de vari√°veis que obteve melhor parti√ß√£o foram as relacionadas a emiss√µes de gases do efeito estufa e consumo total de energia normalizado, assim podemos ver as retas que partem o espa√ßo destas vari√°veis em 3 classes e onde as observa√ß√µes caem em cada classe.

```{r}
#| output-location: slide
#| out-width: 100%
#| fig-height: 6
par(
    bg = "#002b36", fg = "#93a1a1",
    col = "#93a1a1", col.axis = "#93a1a1",
    col.main = "#93a1a1", col.lab = "#93a1a1"
)
klaR::partimat(
    property_type ~ ghg_total + eui_source_wn,
    data = data, method = "lda",
    image.colors = c("#ffcc3240", "#7cb34240", "#f4433640")
)
```

## Caso quadr√°tico {.smaller}
Quando utilizamos desigualdades quadr√°ticas para diferenciar os grupos, temos que a classifica√ß√£o de escolas e supermercados ficou um pouco pior por√©m a de hoteis melhorou bastante, agora a maioria deles est√£o classificados corretamente.

As medidas de acur√°cia est√£o menores que a an√°lise de discriminante linear por√©m isso √© devido a quantidade de observa√ß√µes em cada grupo ser desbalanceada.

```{r}
#| output: false
qda <- qda(property_type ~ . - stars - score, train)

predict <- predict(qda, test)$class
cm <- caret::confusionMatrix(test$property_type, predict)
cm$table
cm$byClass[,1:2]
```

|Classe      |Hotel|Escola|Supermercado|Sensitividade|Especificidade|
|:-----------|----:|-----:|-----------:|------------:|-------------:|
|Hotel       |   44|    25|           4|        0.698|         0.934|
|Escola      |   13|   370|           6|        0.937|         0.819|
|Supermercado|    6|     0|          32|        0.762|         0.987|

## Parti√ß√£o dos grupos
As mudan√ßas entre as regi√µes lineares e qu√°dricas acontecem na diminui√ß√£o das regi√µes de escolas e supermercados, podendo que os hoteis sejam classificados melhores

```{r}
#| output-location: slide
#| out-width: 100%
#| fig-height: 6
par(
    bg = "#002b36", fg = "#93a1a1",
    col = "#93a1a1", col.axis = "#93a1a1",
    col.main = "#93a1a1", col.lab = "#93a1a1"
)
klaR::partimat(
    property_type ~ ghg_total + eui_source_wn,
    data = data, method = "qda",
    image.colors = c("#ffcc3240", "#7cb34240", "#f4433640")
)
```

##
