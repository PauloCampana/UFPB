---
format: 
  revealjs: 
    theme: solarized
lang: pt
bibliography: includes/bib.bibtex
self-contained: true
self-contained-math: true
callout-icon: false
title: Aplicação de Regressão Linear Múltipla na Modelagem de Força Compressiva de Concreto
author:
  - name: Paulo Ricardo Seganfredo Campana
  - name: Gabriel de Jesus Pereira
date: today
date-format: long
warning: false
echo: false
cache: true
monofont: "Ubuntu Mono"
monofontoptions: Scale = 1
fig-cap-location: top
---

```{r}
library(tidyverse)
library(tidymodels)
options(tidymodels.dark = TRUE)
set.seed(42)

data <- concrete |> 
    rename(
        cimento = cement,
        escória_de_aço = blast_furnace_slag,
        cinzas_pulverizadas = fly_ash,
        água = water,
        superplastificante = superplasticizer,
        agregado_graúdo = coarse_aggregate,
        agregado_miúdo = fine_aggregate,
        tempo = age,
        força_compressiva = compressive_strength
    )

splits <- initial_split(data)
train <- training(splits)
test <- testing(splits)
```

## Contextualização 
Como um dos matérias de construção mais utilizados na engenharia civil devido à sua durabilidade, versatilidade e resistência. O concreto é composto por agregados, água e principalmente cimento.

Analisando o cenário e as necessidades da engenharia civil, foi proposto a modelagem da força compressiva do concreto baseado nas substâncias que o compõem e o tempo que a mistura foi deixada para secar.

## Conjunto de dados
Composto de dados experimentais sobre diferentes misturas de concreto de alta performance  [@concrete], contém as seguintes variáveis:

Variável resposta

* `força_compressiva` do concreto (em Megapascal)

##
Variáveis regressoras

* `cimento` (em quilogramas por metro cúbico)
* `escória_de_aço`
* `cinzas_pulverizadas`
* `água`
* `superplastificante`
* `agregado_graúdo`
* `agregado_miúdo`

* `tempo` de secagem da mistura final (em dias) 

## Os modelos estudados
Ajustamos dois modelos de regressão linear:

* Um mais simples utilizando apenas 4 dos regressores e algumas transformações.

* Um mais complexo, trazendo a interação entre as variáveis e composição das mesmas em novas medidas além das transformações.

O segundo modelo obteve melhores metricas de performance, porém não achamos o suficiente para compensar sua complexidade.

## Transformação Yeo-Johnson
Esta transformação [@yeo], de maneira similar a Box-Cox, é feita para tornar a distribuição dos regressores mais normais e estabilizar a variância, com a vantagem de também funcionar para dados que contém valores 0 e números negativos. O parâmetro $\lambda$ é estimado por máxima verossimilhança.

$$
\psi(\lambda, x) = \begin{cases}
    [(1 + x)^\lambda - 1] / \lambda \hspace{+44pt}    \lambda \neq 0, \; x \geqslant 0 \\
    \ln(1 + x)  \hspace{+74pt}                        \lambda = 0, \; x \geqslant 0 \\
    [(1 - x)^{2 - \lambda} - 1] / (\lambda - 2) \quad \lambda \neq 2, \; x < 0 \\
    -\ln(1 - x) \hspace{+65pt}                        \lambda = 2, \; x < 0
\end{cases}
$$

## Especificação do modelo
A escolha de variáveis e transformações usadas foram julgadas através das métricas de performance do coeficiente de determinação ($R^2$) e raiz do erro quadrático médio ($\text{RMSE}$ ou $\sigma$), além de manter todos os coeficientes do modelo significativos nos testes de hipótese individuais e buscando um modelo simples quando possível.

::: {layout-ncol=2}
$$
R^2 = 1 - \dfrac{SS_{\text{resid}}}{SS_{\text{total}}}
$$

$$
\text{RMSE} = \sqrt{\dfrac{1}{n} \sum_{i = 0}^n (\hat y_i - y_i)^2}
$$
::: 

## Verificação das suposições do modelo
Após o ajuste do modelo, realizamos testes para as suposições do modelo, são necessárias para que o mesmo seja válido. Fizemos testes de hipótese para as suposições com um nível de significância de 5% e análises gráficas.

* Normalidade dos resíduos
* Linearidade
* Ausência de multicolinearidade
* Homocedasticidade
* Ausência de autocorrelação

## Variáveis selecionadas e transformações
Para o modelo simples, escolhemos as variáveis que foram mais importantes para o alcance dos objetivos citados acima: `cimento`, `escória_de_aço`, `água` e `tempo`.

Realizamos uma transformação de raiz quadrada na variável resposta, `força_compressiva` e transformações Yeo-Johnson nos regressores exceto `água`, onde a estimativa de $\lambda$ foi muito próximo de 1, desse modo temos as seguintes variáveis transformadas:

## Transformações realizadas

|Variável           | $\lambda$|             Transformação|
|:------------------|---------:|:-------------------------|
|`força_compressiva`|          |$y' = \sqrt y$            |
|`cimento`          |   $0.197$|$x' = \small 5.065 [(1 + x)^{ 0.197} - 1]$|
|`escória_de_aço`   |   $0.066$|$x' = \small 15.16 [(1 + x)^{ 0.066} - 1]$|
|`tempo`            |  $-0.006$|$x' = \ln(1 + x)$         |

## Ferramentas utilizadas
As análises a seguir foram realizadas usando a linguagem de programação R [@R] com o *framework* de modelagem estatística *tidymodels* [@tidymodels]. Os códigos utilizados estão disponíveis no github [@github] e os documentos do relatório e apresentação foram feitos com Quarto [@quarto], um sistema de escrita e publicação científica.

```{r}
workflow <- workflow() |> 
    add_model(linear_reg(), formula = força_compressiva ~ . - 1) |> 
    add_recipe(
        train |> 
            recipe(força_compressiva ~ cimento + escória_de_aço + água + tempo) |>
            step_sqrt(força_compressiva) |> 
            step_YeoJohnson(cimento, escória_de_aço, tempo) |> 
            step_mutate(tempo2 = tempo^2, tempo3 = tempo^3) |> 
            step_rm(tempo)
    )

model <- workflow |> 
    fit(data) |> 
    extract_fit_engine()
```

## Modelo ajustado
Devido a relação entre a força compressiva e o tempo de secagem ser não linear, criamos duas variáveis com o tempo transformado: tempo ao quadrado e tempo ao cubo. 

Ajustando um modelo sem intercepto com essas variáveis temos a seguinte relação entre a força compressiva do concreto ($y'$), a quantidade de cimento ($x_1'$), escória de aço ($x_2'$), água ($x_3$) e o tempo de secagem ($x_t'$):

$$
\small
\hat y' = 0.769 x_1' + 0.186 x_2' - 0.023 x_3 + 0.396 x_t'^2 - 0.050 x_t'^3
$$

## Verificação das suposições do modelo
A seguir, veremos os testes de hipótese e gráficos para as suposições necessárias para criação de um modelo linear válido.

## Resultado dos testes para normalidade

|Teste           | Estatística| p-valor|
|:---------------|-----------:|-------:|
|Anderson-Darling| $A = 0.812$| $0.035$|
|Cramer-von Mises| $W = 0.155$| $0.020$|
|Lilliefors      | $D = 0.034$| $0.007$|
|Pearson         | $P = 29.97$| $0.467$|
|Shapiro-Francia | $W = 0.998$| $0.263$|
|Shapiro-Wilk    | $W = 0.998$| $0.217$|
|Jarque-Bera     |$JB = 1.578$| $0.454$|

## Q-Q plot dos resíduos padronizados
```{r}
#| fig-height: 6
#| fig-width: 6
#| fig-pos: center

data |> 
    ggplot(aes(sample = rstandard(model))) +
    geom_qq(color = "#21908C", alpha = 0.25) +
    geom_abline(alpha = 0.1) +
    coord_obs_pred() +
    labs(x = "Quantil teórico", y = "Quantil observado") +
    theme_bw() + theme(
        plot.background = element_rect("#fdf6e3"),
        panel.background = element_blank(),
        panel.grid = element_line("#586e7540"),
        axis.ticks = element_line("#586e7540"),
        text = element_text(colour = "#586e75", size = 18),
        axis.text = element_text(colour = "#586e75", size = 16)
    )
```

## Resultado dos testes para linearidade

|Teste           | Estatística|    p-valor|
|:---------------|-----------:|:----------|
|RESET           | $R = 0.800$|$0.371$    |
|Rainbow         | $R = 1.407$|$5.797 \times 10^{-5}$|

Os testes para linearidade do modelo discordam entre si, porém pelo gráfico a seguir os valores estimados do modelo para a força compressiva do concreto parecem estar de acordo com os valores observados. 

## Gráfico dos valores observados versus estimados
```{r}
#| fig-height: 6
#| fig-width: 7.8
#| fig-pos: center

workflow |>
    fit(data) |> 
    extract_fit_engine() |> 
    augment(new_data = data) |> 
    ggplot(aes(x = força_compressiva, y = .fitted)) +
    geom_point(aes(color = .std.resid), alpha = 0.5) +
    geom_abline(alpha = 0.25) +
    scale_color_viridis_c() +
    coord_obs_pred() +
    labs(
        x = "Força compressiva observada",
        y = "Força compressiva estimada",
        color = "Resíduo\nPadronizado"
    ) +
    theme_bw() + theme(
        plot.background = element_rect("#fdf6e3"),
        panel.background = element_blank(),
        legend.background = element_blank(),
        panel.grid = element_line("#586e7540"),
        axis.ticks = element_line("#586e7540"),
        text = element_text(colour = "#586e75", size = 18),
        axis.text = element_text(colour = "#586e75", size = 16)
    )
```

## Teste $t$ para os coeficientes do modelo

|Termo    | Estimativa|Erro padrão|Estatística|p-valor          |
|:--------|----------:|----------:|----------:|:----------------|
|$x_1'$   |    $0.769$|   $0.0134$|    $57.36$|$3.36 \times 10^{-322}$|
|$x_2'$   |    $0.186$|   $0.0079$|    $23.69$|$2.55 \times 10^{- 99}$|
|$x_3'$   |   $-0.023$|   $0.0007$|   $-32.58$|$2.16 \times 10^{-160}$|
|$x_t'^2$ |    $0.396$|   $0.0134$|    $29.67$|$3.50 \times 10^{-140}$|
|$x_t'^3$ |   $-0.050$|   $0.0023$|   $-21.53$|$4.17 \times 10^{- 85}$|

## Gráfico da matriz de correlação
![](includes/multi.png){fig-align=center}

## Resultado dos testes para homocedasticidade

|Teste           |  Estatística| p-valor|
|:---------------|------------:|-------:|
|Breusch-Pagan   | $BP = 4.776$| $0.311$|
|Koenker         | $BP = 5.155$| $0.272$|
|Goldfeld-Quandt | $GQ = 1.059$| $0.258$|
|Harrison-McCabe |$HMC = 0.505$| $0.608$|

## Gráfico dos valores estimados versus resíduos
```{r}
#| fig-height: 6
#| out-width: 100%
#| fig-pos: center

workflow |>
    fit(data) |> 
    extract_fit_engine() |> 
    augment(new_data = data) |> 
    ggplot(aes(x = .fitted, y = .std.resid)) +
    geom_point(aes(color = .std.resid), alpha = 0.5) +
    geom_smooth(color = "#00000040", se = FALSE) +
    scale_color_viridis_c() +
    labs(
        x = "Força compressiva estimada",
        y = "Resíduo padronizado",
        color = "Resíduo\nPadronizado"
    ) +
    theme_bw() + theme(
        plot.background = element_rect("#fdf6e3"),
        panel.background = element_blank(),
        legend.background = element_blank(),
        panel.grid = element_line("#586e7540"),
        axis.ticks = element_line("#586e7540"),
        text = element_text(colour = "#586e75", size = 18),
        axis.text = element_text(colour = "#586e75", size = 16)
    )
```

## Resultado dos testes para autocorrelação

|Teste           | Estatística|    p-valor|
|:---------------|-----------:|:----------|
|Breusch-Godfrey |$LM = 169.3$|$1.05 \times 10^{-38}$|
|Durbin-Watson   | $R = 1.187$|$1.01 \times 10^{-39}$|

Os resíduos do modelo são de fato correlacionados entre observações sequenciais, pois se tratam de dados experimentais, as diferentes combinações entre substâncias na mistura do concreto e tempo de secagem são feitas de modo estruturado.

## Explicação
No conjunto de dados, é comum a ocorrência de 5 observações sequenciais com a mesma mistura porém com tempos de secagem diferentes: 3, 14, 28, 56 e 100 dias, ou dezenas de observações seguidas em que não ouve presença de escória de aço na mistura.

Sendo assim, a autocorrelação dos resíduos se dá pela estrutura dos dados experimentais, não por uma relação temporal entre cada experimento.

## Métricas de performance
O modelo alcançou um $R^2$ de 80.82% e uma raiz de erro quadrático médio ($\text{RMSE}$) de 0.607. Isso significa que as 4 variáveis utilizadas: quantidade de cimento, escória de aço, água e o tempo de secagem conseguem explicar cerca de 80% da variáção da força compressiva do concreto.

O segundo modelo mais complexo, possuía 20 coeficientes, todos significativos, obteve um $R^2$ de 85%, não achamos esse alto aumento de complexidade útil para um aumento não tão grande de performance.

## Intervalo de confiança dos coeficientes

|Coeficientes|Limite inferior|Limite superior|
|:-----------|------:|------:|
|$x_1'$ (cimento)| $0.743$| $0.795$|
|$x_2'$ (escória)| $0.171$| $0.201$|
|$x_3$  (água)   |$-0.024$|$-0.022$|
|$x_t'^2$ (tempo)| $0.370$| $0.422$|
|$x_t'^3$ (tempo)|$-0.055$|$-0.046$|

## Interpretação dos coeficientes
Como visto anteriormente, com as transformações utilizadas, todas as variáveis regressoras da modelagem são altamente significativas. A interpretação numérica dos coeficientes não é útil devido as transformações feitas na variável resposta e nos regressores. Porém podemos falar sobre o efeito dos regressores já que as transformações mantem a ordem dos valores.

## Tempo de secagem
Desse modo, Ao deixar o concreto secando por mais tempo, vemos pelo coeficiente de $x_t'^2$ que há um impacto positivo na força compressiva do concreto. No entanto, o coeficiente de $x_t'^3$ nos trás a informação de que deixar a mistura secando por muito tempo tem impacto negativo na variável resposta. 

## Água, concreto e escória de aço
Para o coeficiente negativo da presença de água na mistura: $x_3$, vemos que misturas com grandes quantidades de água não contribuem para um concreto mais resistente, por outro lado, a presença de maiores quantidades de cimento e escória de aço representam um aumento na força compressiva.

## Conclusão
O modelo talvez não cumpre com a suposição de linearidade e também não passa em tetes de autocorrelação devido a natureza de dados estruturados que provêm de experimentos, vimos que o modelo estudado cumpre com as suposições de normalidade, ausência de multicolinearidade e homocedasticidade.

## Conclusão
Este modelo produz predições precisas da força compressiva do concreto, não obstante suprindo uma demanda para fabricantes de concreto e pesquisadores da Engenharia Civil, dessa forma, o modelo procura atender as necessidades do mercado da construção, permitindo com que, com a especificação dos componentes do concreto chegamos em uma estimativa de sua força compressiva.

## Referências
::: {#refs}
:::
