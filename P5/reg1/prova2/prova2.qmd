---
format: pdf
lang: pt
title: Prova 2
author: Paulo Ricardo Seganfredo Campana
date: today
date-format: long
callout-icon: false
highlight-style: github
monofont: "Ubuntu Mono"
monofontoptions: Scale = 1
---

::: hidden
\pagestyle{empty}
\thispagestyle{empty}
:::

```{r}
#| echo: false
#| warning: false
library(tidyverse)
options(digits = 3)
```

::: callout-note
# **Questão:**
Os dados da **Tabela B.3** do livro do *Montgomery* podem ser encontrados no pacote *MPV* do **R** como o nome *table.b3*. Estes dados consistem de 32 observações sobre sobre o consumo de combustível de diferentes automóveis, com variáveis sobre o desempenho da quilometragem da gasolina e características físicas e/ou de performance.
:::

a) Ajuste um modelo de regressão múltipla que explica o consumo de combustível do carro $y$ (em milhas por galão) através da cilindrada ($x_1$), dos cavalos de potência ($x_2$), do comprimento ($x_8$), da largura ($x_9$) e seu peso ($x_10$).

```{r}
#| collapse: true
data <- MPV::table.b3
fit1 <- lm(y ~ x1 + x2 + x8 + x9 + x10, data)
fit1$coefficients
```

$$
\hat y = 29.3 - 0.0346 x_1 + 0.02 x_2 + 0.143 x_8 - 0.187 x_9 - 0.004 x_{10}
$$

b) Através do teste $F$, você acha que o modelo adotado é razoável? Justifique sua resposta.

```{r}
#| output: false
summary(fit1)$fstatistic
## F-statistic: 21.8 on 5 and 26 DF,  p-value: 1.54e-08
```

Sim, o teste $F$ trás p-valor baixo de $1.54 \times 10^{-8}$ o que indica que a regressão é significante.

{{< pagebreak >}}

c) O $R^2$ e $R^2_a$ sugerem que o modelo proposto explica razoavelmente os dados?

```{r}
#| collapse: true
summary(fit1)$r.squared
summary(fit1)$adj.r.squared
```

Sim, as variáveis do modelo explicam em torno de 80% da variabilidade do consumo de combustível.

d) Dadas as análises das letras **b)** e **c)** como podemos justificar os resultados dos testes $t$ para os coeficientes da regressão?

```{r}
summary(fit1) |> broom::tidy() |> knitr::kable()
```

Por mais que pelo teste $F$ e coeficientes $R^2$ a regressão seja razoável, nenhum coeficiente do modelo é significante no teste $t$, isso indica que o modelo sofre de multicolinearidade já que a correlação entre as variáveis regressoras são muito altas, o efeito da variável $x_{10}$ por exemplo, já foi explicado pelas anteriores.

```{r}
cor(fit1$model) |> knitr::kable()
```

e) Estime agora um modelo de regressão que relaciona o consumo de combustível do carro $y$ apenas com a cilindrada $x_1$. Considerando este modelo faça as seguintes análises.

```{r}
#| collapse: true
fit2 <- lm(y ~ x1, data)
fit2$coefficients
```

$$
\hat y = 33.722 - 0.0474 x_1
$$

f) Construa um gráfico para verificar a suposição de normalidade? Parece haver algum problema com esta suposição?

```{r}
#| echo: false
#| out-width: 100%
data |> 
    ggplot(aes(sample = rstandard(fit2))) +
    geom_qq(color = "#4582ec") +
    geom_abline(slope = 1, intercept = 0, alpha = 0.25) +
    coord_equal() +
    labs(
        x = "Quantis teóricos",
        y = "Resíduos padronizados"
    ) +
    theme_bw()
```

Não, o Q-Q plot não apresenta altos desvios da normalidade.

g) Construa um gráfico dos valores observados $y$ versus a resposta prevista. Este gráfico é frequentemente utilizado para verificar qual suposição? Analisando este gráfico, o que é possível observar?

É usado para verificar a linearidade do modelo, neste gráfico vemos que para altos valores do consumo de combustível, o modelo está prevendo abaixo do esperado.

```{r}
#| echo: false
#| out-width: 100%
data |> 
    ggplot(aes(x = y, y = predict(fit2))) +
    geom_point(color = "#4582ec") +
    geom_abline(slope = 1, intercept = 0, alpha = 0.25) +
    tune::coord_obs_pred() +
    labs(
        x = "Consumo de combustível observado",
        y = "Consumo de combustível previsto"
    ) +
    theme_bw()
```

h) Construa um gráfico dos resíduos padronizados versus a resposta prevista. O que é possível analisar neste gráfico?

```{r}
#| echo: false
#| warning: false
#| out-width: 100%
#| fig-height: 3
data |> 
    ggplot(aes(x = predict(fit2), y = rstandard(fit2))) +
    geom_point(color = "#4582ec") +
    geom_abline(slope = 0, intercept = 0, alpha = 0.25) +
    geom_smooth(color = "#00000040", se = FALSE, method = "gam") +
    labs(
        x = "Consumo de combustível previsto",
        y = "Resíduos padronizados"
    ) +
    theme_bw()
```

Vemos que os resíduos não possuem média 0 e variância constante para diferentes valores de $y$, isso indica a heterocedasticidade do modelo. 

i) Verifique a hipótese de normalidade. Comente os resultados.

```{r}
#| output: false
nortest::lillie.test(rstandard(fit2))
## D = 0.08, p-value = 0.898
shapiro.test(rstandard(fit2))
## W = 1, p-value = 0.955
moments::jarque.test(rstandard(fit2))
## JB = 0.2, p-value = 0.922
```

Nenhum teste rejeita a normalidade dos resíduos.

j) Verifique a hipótese de linearidade. Comente os resultados.

```{r}
#| output: false
lmtest::reset(fit2)
## RESET = 7.0941, df1 = 2, df2 = 28, p-value = 0.00322
lmtest::raintest(fit2)
## Rain = 0.38034, df1 = 16, df2 = 14, p-value = 0.967
```

Os testes para a linearidade do modelo discordam em seus resultados.

O teste RESET indica que o modelo pode ser melhorado com transformações não lineares das variáveis regressoras. O teste Rainbow nos diz que o mesmo modelo ajustado com um subconjunto dos dados tem performance similar ao modelo original.

k) Verifique a hipótese de autocorrelação. Comente os resultados.

```{r}
#| output: false
lmtest::dwtest(fit2)
## DW = 1.6773, p-value = 0.17
```

Segundo o teste de Durbin-Watson, não há autocorrelação no modelo.

l) Verifique a hipótese de homocedasticidade. Comente os resultados.

```{r}
#| output: false
lmtest::gqtest(fit2)
## GQ = 0.72362, df1 = 14, df2 = 14, p-value = 0.723
lmtest::bptest(fit2, studentize = FALSE)
## BP = 4.9086, df = 1, p-value = 0.0267
lmtest::bptest(fit2, studentize = TRUE)
## BP = 5.3609, df = 1, p-value = 0.0206
```

Os testes para a heterocedasticidade do modelo discordam em seus resultados.

O teste de Goldfeld-Quandt não detecta heterocedasticidade enquanto que os testes de Breush-Pagan e Koenker conseguem detectar.
